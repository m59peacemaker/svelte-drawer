<div
  class="
    svelte-drawer
    side-{{ side }}
    axis-{{ axis }}
  "
  data-open="{{ open }}"
  data-opening="{{ opening }}"
  data-closing="{{ closing }}"
  data-closed="{{ closed }}"
  style="
    transform: translate3d({{ translate.x }}%, {{ translate.y }}%, 0);
    z-index: {{ zIndexBase + 1 }};
  "
>
  <slot></slot>
</div>

{{#if scrim && !closed && !closing}}
  <div
    style="z-index: {{ zIndexBase }};"
    on:click="close()"
  >
    <slot name="scrim">
      <Scrim/>
    </slot>
  </div>
{{/if}}

<script>
import { spring } from 'svelte-extras'
import Scrim from 'svelte-scrim'
import clamp from 'just-clamp'

const isLeadingSide = side => side === 'left' || side === 'top'

const DEFAULTS = {
  percentOpen: 0,
  side: 'left',
  scrim: true,
  zIndexBase: 1
  //push: false // false, element/ref // TODO: push other content over when opening
}
Object.freeze(DEFAULTS)

export default {
  setup (Drawer) {
    Drawer.DEFAULTS = DEFAULTS
  },

  components: { Scrim },

  data () {
    return Object.assign({}, DEFAULTS)
  },

  computed: {
    open: percentOpen => percentOpen === 100,
    closed: percentOpen => percentOpen < 1,
    axis: side => side === 'left' || side === 'right' ? 'x' : 'y',
    translate: (percentOpen, side, axis) => {
      const amount = isLeadingSide(side) ? percentOpen - 100 : 100 - percentOpen
      return axis === 'x' ? { x: amount, y: 0 } : { x: 0, y: amount }
    },
  },

  methods: {
    spring,

    setPercentOpen (percent, { smooth = true } = {}) {
      const percentOpen = clamp(0, percent, 100)
      return smooth
        ? this.spring('percentOpen', percentOpen, { stiffness: 0.2, damping: 0.9 })
        : Promise.resolve(this.set({ percentOpen }))
    },

    open ({ smooth = true } = {}) {
      this.set({ opening: true, closing: false })
      return this.setPercentOpen(100, { smooth })
        .then(() => this.set({ opening: false }))
    },

    close ({ smooth = true } = {}) {
      this.set({ closing: true, opening: false })
      this.setPercentOpen(0, { smooth })
        .then(() => this.set({ closing: false }))
    },

    toggle ({ smooth = true } = {}) {
      const shouldClose = this.get('open') || this.get('opening')
      this[shouldClose ? 'close' : 'open']({ smooth })
    }
  }
}
</script>

<style>

.svelte-drawer {
  position: fixed;
  display: inline;
  transform: translate3d(0, 0, 0);
}

.axis-x {
  top: 0;
  bottom: 0;
  height: 100%;
}

.axis-y {
  left: 0;
  right: 0;
  width: 100%;
}

.side-top    { top: 0 }
.side-right  { right: 0 }
.side-bottom { bottom: 0 }
.side-left   { left: 0 }

</style>
